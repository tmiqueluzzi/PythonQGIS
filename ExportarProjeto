import processing
import os
from qgis.core import QgsProject, QgsVectorLayer

# Caminho de sa√≠da do GeoPackage
output_gpkg = "C:/Users/theom/Documents/Teste Python/teste_py_10.gpkg"
output_folder = os.path.dirname(output_gpkg)  # Obt√©m a pasta do GPKG
txt_file_path = os.path.join(output_folder, "camadas_nao_exportadas.txt")  # Caminho do arquivo .txt

# Obt√©m todas as camadas carregadas no projeto
all_layers = QgsProject.instance().mapLayers().values()

# Filtra apenas camadas SHP para exporta√ß√£o
layers_to_export = [layer for layer in all_layers if isinstance(layer, QgsVectorLayer) and layer.source().endswith(".shp")]

# Filtra camadas que n√£o s√£o SHP (raster, tabela, WMS, etc.)
non_shp_layers = [layer.name() for layer in all_layers if layer not in layers_to_export]

# Se houver camadas n√£o exportadas, salva no arquivo .txt
if non_shp_layers:
    with open(txt_file_path, "w", encoding="utf-8") as txt_file:
        txt_file.write("Camadas n√£o exportadas (n√£o s√£o SHP):\n")
        txt_file.write("\n".join(non_shp_layers))

# Verifica se h√° camadas para exporta√ß√£o
if not layers_to_export:
    print("‚ö†Ô∏è Nenhuma camada SHP encontrada no projeto!")
else:
    # Par√¢metros para empacotar as camadas no GPKG
    params = {
        'LAYERS': layers_to_export,
        'OUTPUT': output_gpkg,
        'OVERWRITE': False,               # N√£o sobrescreve se j√° existir
        'SAVE_METADATA': True,            # Salva metadados
        'SAVE_STYLES': True,              # Mant√©m a simbologia
        'SELECTED_FEATURES_ONLY': False,  # Exporta todas as fei√ß√µes
        'EXPORT_RELATED_LAYERS': False    # N√£o inclui camadas relacionadas
    }

    # Executa a ferramenta de empacotamento
    processing.run("native:package", params)

    print(f"‚úÖ Exporta√ß√£o conclu√≠da! Camadas SHP salvas em {output_gpkg}")

    # Mensagem sobre o arquivo .txt
    if non_shp_layers:
        print(f"‚ö†Ô∏è Algumas camadas n√£o foram exportadas. Veja o relat√≥rio em: {txt_file_path}")

    for nome in camadas_nao_vetoriais:
        print(f"‚ùå {nome}")
else:
    print("Todas as camadas eram vetoriais e foram exportadas com sucesso. üéâ")
